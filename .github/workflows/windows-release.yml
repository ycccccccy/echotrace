name: Build Windows & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      - run: flutter clean
      - run: flutter pub get
      - run: flutter build windows --release

      - name: Build zip
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $src = "build/windows/x64/runner/Release"
          $zip = "echotrace-windows-$tag.zip"
          if (!(Test-Path $src)) { dir build/windows -Recurse; throw "build output not found" }
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$src/*" -DestinationPath $zip -Force
          "ZIP_NAME=$zip" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build msix
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $v = $tag.TrimStart("v")
          $msixVersion = "$v.0"

          dart run msix:create --version $msixVersion --certificate-path none

          $out = Get-ChildItem -Recurse -Filter "*.msix" | Select-Object -First 1
          if (!$out) { throw "msix not found" }

          $name = "echotrace-windows-$tag.msix"
          if (Test-Path $name) { Remove-Item $name -Force }
          Move-Item $out.FullName $name

          "MSIX_NAME=$name" | Out-File -FilePath $env:GITHUB_ENV -Append

          
      - name: Build release body
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require("child_process");
            const fs = require("fs");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = context.ref.replace("refs/tags/", "");
            const tags = execSync("git tag --sort=-creatordate").toString().trim().split("\n").filter(Boolean);
            const idx = tags.indexOf(tag);
            const prev = idx >= 0 && idx + 1 < tags.length ? tags[idx + 1] : null;
            const gen = await github.request("POST /repos/{owner}/{repo}/releases/generate-notes", {
              owner,
              repo,
              tag_name: tag,
              previous_tag_name: prev || undefined
            });
            let body = gen.data.body || "";
            if (prev) {
              const cmp = await github.request("GET /repos/{owner}/{repo}/compare/{base}...{head}", {
                owner,
                repo,
                base: prev,
                head: tag
              });
              body += "\n\n---\n\n## Commits\n";
              body += (cmp.data.commits || [])
                .map(c => `- ${c.commit.message.split("\n")[0]} (${c.sha.slice(0,7)}) ${c.html_url}`)
                .join("\n");
            }
            fs.writeFileSync("RELEASE_NOTES.md", body);

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          files: |
            ${{ env.ZIP_NAME }}
            ${{ env.MSIX_NAME }}
